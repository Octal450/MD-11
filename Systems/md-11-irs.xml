<?xml version="1.0"?>

<!-- McDonnell Douglas MD-11 Inertial Reference System -->
<!-- Copyright (c) 2020 Josh Davidson (Octal450) -->

<system name="MD-11: IRS">
	
	<property value="0">/systems/iru[0]/aligned</property>
	<property value="0">/systems/iru[1]/aligned</property>
	<property value="0">/systems/iru[2]/aligned</property>
	
	<channel name="Logic" execrate="8">
		
		<switch name="/systems/iru-common/align-time">
			<default value="0.00166667"/> <!-- 600 seconds -->
			<test logic="OR" value="0.5"> <!-- 2 seconds -->
				/systems/iru-common/align-instantly eq 1
				/systems/acconfig/autoconfig-running eq 1
			</test>
		</switch>
		
		<switch name="/systems/iru[0]/powered"> <!-- DC-BAT is temporary, replace with dedicated battery later -->
			<default value="0"/>
			<test logic="OR" value="1">
				/systems/electrical/bus/ac-1 ge 110
				/systems/electrical/bus/dc-bat ge 25
			</test>
		</switch>
		
		<switch name="/systems/iru[1]/powered"> <!-- DC-BAT is temporary, replace with dedicated battery later -->
			<default value="0"/>
			<test logic="OR" value="1">
				/systems/electrical/bus/ac-2 ge 110
				/systems/electrical/bus/dc-bat ge 25
			</test>
		</switch>
		
		<switch name="/systems/iru[2]/powered"> <!-- DC-BAT is temporary, replace with dedicated battery later -->
			<default value="0"/>
			<test logic="OR" value="1">
				/systems/electrical/bus/ac-3 ge 110
				/systems/electrical/bus/dc-bat ge 25
			</test>
		</switch>
		
		<!-- Uncomment when MCDU is added -->
		<!--switch name="/systems/iru-common/mcdu-btn">
			<default value="/controls/iru-common/mcdu-btn"/>
			<test logic="AND" value="0">
				/controls/iru[0]/switches/knob ne 1
				/controls/iru[1]/switches/knob ne 1
				/controls/iru[2]/switches/knob ne 1
			</test>
			<output>/controls/iru-common/mcdu-btn</output>
		</switch-->
	
	</channel>
	
	<channel name="IRU 1 Alignment" execrate="8">
		
		<switch name="/systems/iru[0]/can-align"> <!-- Flip flop, so that if it can't aligned, switch must be re-aligned -->
			<default value="/systems/iru[0]/can-align"/>
			<test value="1">
				/systems/iru[0]/aligned eq 1
			</test>
			<test logic="OR" value="0">
				/orientation/pitch-rate-degps lt -1
				/orientation/pitch-rate-degps gt 1
				/orientation/roll-rate-degps lt -1
				/orientation/roll-rate-degps gt 1
				/velocities/groundspeed-kt gt 2
			</test>
			<test logic="AND" value="1"> <!-- Only reset when the switch is off -->
				/controls/iru[0]/switches/knob ne 1
			</test>
		</switch>
		
		<switch name="/systems/iru[0]/align-cmd">
			<default value="0"/>
			<test logic="AND" value="0"> <!-- Cancel align if not aligned and can't align -->
				/systems/iru[0]/aligned ne 1
				/systems/iru[0]/can-align ne 1
			</test>
			<test logic="AND" value="1">
				/controls/iru[0]/switches/knob eq 1
				/systems/iru[0]/powered eq 1
			</test>
		</switch>
		
		<actuator name="/systems/iru[0]/align-timer">
			<input>/systems/iru[0]/align-cmd</input>
			<rate_limit sense="incr">/systems/iru-common/align-time</rate_limit>
			<rate_limit sense="decr">100000</rate_limit>
			<output>/systems/iru[0]/align-timer-debug</output>
		</actuator>
		
		<switch name="/systems/iru[0]/aligned">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/iru[0]/align-timer eq 1
				/controls/iru-common/mcdu-btn eq 1
			</test>
		</switch>
		
		<switch name="/systems/iru[0]/aligning">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/iru[0]/align-cmd eq 1
				/systems/iru[0]/aligned ne 1
			</test>
		</switch>
	
	</channel>
	
	<channel name="IRU 2 Alignment" execrate="8">
		
		<switch name="/systems/iru[1]/can-align"> <!-- Flip flop, so that if it can't aligned, switch must be re-aligned -->
			<default value="/systems/iru[1]/can-align"/>
			<test value="1">
				/systems/iru[1]/aligned eq 1
			</test>
			<test logic="OR" value="0">
				/orientation/pitch-rate-degps lt -1
				/orientation/pitch-rate-degps gt 1
				/orientation/roll-rate-degps lt -1
				/orientation/roll-rate-degps gt 1
				/velocities/groundspeed-kt gt 2
			</test>
			<test logic="AND" value="1"> <!-- Only reset when the switch is off -->
				/controls/iru[1]/switches/knob ne 1
			</test>
		</switch>
		
		<switch name="/systems/iru[1]/align-cmd">
			<default value="0"/>
			<test logic="AND" value="0"> <!-- Cancel align if not aligned and can't align -->
				/systems/iru[1]/aligned ne 1
				/systems/iru[1]/can-align ne 1
			</test>
			<test logic="AND" value="1">
				/controls/iru[1]/switches/knob eq 1
				/systems/iru[1]/powered eq 1
			</test>
		</switch>
		
		<actuator name="/systems/iru[1]/align-timer">
			<input>/systems/iru[1]/align-cmd</input>
			<rate_limit sense="incr">/systems/iru-common/align-time</rate_limit>
			<rate_limit sense="decr">100000</rate_limit>
			<output>/systems/iru[1]/align-timer-debug</output>
		</actuator>
		
		<switch name="/systems/iru[1]/aligned">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/iru[1]/align-timer eq 1
				/controls/iru-common/mcdu-btn eq 1
			</test>
		</switch>
		
		<switch name="/systems/iru[1]/aligning">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/iru[1]/align-cmd eq 1
				/systems/iru[1]/aligned ne 1
			</test>
		</switch>
	
	</channel>
	
	<channel name="IRU 3 Alignment" execrate="8">
		
		<switch name="/systems/iru[2]/can-align"> <!-- Flip flop, so that if it can't aligned, switch must be re-aligned -->
			<default value="/systems/iru[2]/can-align"/>
			<test value="1">
				/systems/iru[2]/aligned eq 1
			</test>
			<test logic="OR" value="0">
				/orientation/pitch-rate-degps lt -1
				/orientation/pitch-rate-degps gt 1
				/orientation/roll-rate-degps lt -1
				/orientation/roll-rate-degps gt 1
				/velocities/groundspeed-kt gt 2
			</test>
			<test logic="AND" value="1"> <!-- Only reset when the switch is off -->
				/controls/iru[2]/switches/knob ne 1
			</test>
		</switch>
		
		<switch name="/systems/iru[2]/align-cmd">
			<default value="0"/>
			<test logic="AND" value="0"> <!-- Cancel align if not aligned and can't align -->
				/systems/iru[2]/aligned ne 1
				/systems/iru[2]/can-align ne 1
			</test>
			<test logic="AND" value="1">
				/controls/iru[2]/switches/knob eq 1
				/systems/iru[2]/powered eq 1
			</test>
		</switch>
		
		<actuator name="/systems/iru[2]/align-timer">
			<input>/systems/iru[2]/align-cmd</input>
			<rate_limit sense="incr">/systems/iru-common/align-time</rate_limit>
			<rate_limit sense="decr">100000</rate_limit>
			<output>/systems/iru[2]/align-timer-debug</output>
		</actuator>
		
		<switch name="/systems/iru[2]/aligned">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/iru[2]/align-timer eq 1
				/controls/iru-common/mcdu-btn eq 1
			</test>
		</switch>
		
		<switch name="/systems/iru[2]/aligning">
			<default value="0"/>
			<test logic="AND" value="1">
				/systems/iru[2]/align-cmd eq 1
				/systems/iru[2]/aligned ne 1
			</test>
		</switch>
	
	</channel>

</system>
