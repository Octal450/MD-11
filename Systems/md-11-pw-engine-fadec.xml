<?xml version="1.0"?>

<!-- McDonnell Douglas MD-11 PW4462 Engine/FADEC -->
<!-- Copyright (c) 2020 Josh Davidson (Octal450) -->

<system name="MD-11: PW Engine/FADEC">
	
	<property value="1">fadec/epr/c1</property> <!-- Done in property rule because its easier to tune -->
	<property value="1">fadec/epr/c2</property> <!-- Done in property rule because its easier to tune -->
	<property value="1">fadec/limit/packs-off</property>
	<property value="0">fadec/limit/flex-active</property>
	<property value="30">fadec/limit/flex-temp</property>
	<property value="0">fadec/throttle-compare-max</property> <!-- In afs-thrust.xml for a reason -->
	
	<channel name="Thrust Limits">
		
		<fcs_function name="fadec/limit/rated-thrust-n1">
			<function>
				<table>
					<independentVar lookup="row">/position/altitude-ft</independentVar>
					<independentVar lookup="column">propulsion/tat-c</independentVar>
					<tableData>
						      -60   -30     0      30     60
						    0  90.3   95.9  101.0  106.0  100.8
						10000  96.4  100.2  105.6  107.1  102.6
						43000  96.4   96.7  102.1  107.4  105.1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/milthrust-unmodified"> <!-- Copy of MilThrust table in engines file -->
			<function>
				<table>
					<independentVar lookup="row">velocities/mach</independentVar>
					<independentVar lookup="column">atmosphere/density-altitude</independentVar>
					<tableData>
						     -10000   0       10000   20000   30000   43000   50000
						0.0   1.2600  1.0000  0.7400  0.5640  0.3920  0.2710  0.0000
						0.2   1.1710  0.9740  0.6970  0.5360  0.3850  0.2610  0.0000
						0.4   1.1500  0.9570  0.6920  0.5460  0.3870  0.2530  0.0000
						0.6   1.1810  0.9410  0.7210  0.5660  0.3580  0.2180  0.0000
						0.8   1.2290  1.0200  0.7820  0.5570  0.3040  0.1930  0.0000
						0.9   1.2580  1.0200  0.7820  0.5220  0.2710  0.1140  0.0000
						1.0   1.1810  0.9510  0.7210  0.4410  0.1740  0.0450  0.0000
						1.2   0.0000  0.0000  0.0000  0.0000  0.0000  0.0000  0.0000
						1.4   0.0000  0.0000  0.0000  0.0000  0.0000  0.0000  0.0000
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<!-- Following functions fix a FGTurbine inaccuracy... rated thrust N1% should be rated thrust lbs -->
		<!-- These calculations change it so that the rated power at sea level is at the correct N1% value. It still changes with altitude and mach as it should -->
		<fcs_function name="fadec/limit/fgturbine-thrust-lbs">
			<function>
				<sum>
					<product>
						<property>propulsion/engine/IdleThrust</property>
						<value>62000</value>
					</product>
					<product>
						<difference>
							<value>62000</value>
							<product>
								<property>propulsion/engine[0]/IdleThrust</property> <!-- It doesn't matter which engine, its same for all -->
								<value>62000</value>
							</product>
						</difference>
						<property>fadec/limit/milthrust-unmodified</property>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/rated-thrust-lbs">
			<function>
				<sum>
					<product>
						<property>propulsion/engine/IdleThrust</property>
						<value>62000</value>
					</product>
					<product>
						<product>
							<difference>
								<value>62000</value>
								<product>
									<property>propulsion/engine[0]/IdleThrust</property> <!-- It doesn't matter which engine, its same for all -->
									<value>62000</value>
								</product>
							</difference>
							<property>fadec/limit/milthrust-unmodified</property>
						</product>
						<quotient>
							<difference>
								<property>fadec/limit/rated-thrust-n1</property>
								<value>23.8</value>
							</difference>
							<value>87.6</value>
						</quotient>
						<quotient>
							<difference>
								<property>fadec/limit/rated-thrust-n1</property>
								<value>23.8</value>
							</difference>
							<value>87.6</value>
						</quotient>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/rated-thrust-factor"> <!-- Normalize -->
			<function>
				<ifthen>
					<nq> <!-- Prevent divide by 0 -->
						<property>fadec/limit/rated-thrust-lbs</property>
						<value>0</value>
					</nq>
					<quotient>
						<property>fadec/limit/fgturbine-thrust-lbs</property>
						<property>fadec/limit/rated-thrust-lbs</property>
					</quotient>
					<value>1</value>
				</ifthen>
			</function>
		</fcs_function>
		
		<!-- 
		Thrust limits on the PW are kinda hard to do because of EPR - and we don't have a linear way to control throttle
		The GE's just use N1, which is linear so it works well to make the FADEC, but as stated primary param is EPR
		So we have our thrust limits basic in N1 because its easier to calculate, then we calculate corrected EPR
		After we round the EPR, in order to correctly control/limit thrust, we will convert it BACK to N1... annoying right?
		Well the advantage is the plane is actually targetting EPR, so its more realistic to do this way even if its more steps
		I think that's better than just pretending to use EPR, and actually using N1 - if you look close enough, you can tell!
		-->
		<fcs_function name="fadec/limit/go-around-input">
			<function>
				<pow>
					<property>fadec/limit/rated-thrust-n1</property>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/go-around-ref">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/limit/go-around-input</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/go-around">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/go-around-ref</property>
								<value>1000</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>1000</value>
				</quotient>
			</function>
		</fcs_function>
		
		<switch name="fadec/limit/to-ref-temp">
			<default value="propulsion/tat-c"/>
			<test value="fadec/limit/flex-temp">
				fadec/limit/flex-active eq 1
			</test>
		</switch>
		
		<fcs_function name="fadec/limit/takeoff-input">
			<function>
				<pow>
					<sum>
						<table>
							<independentVar lookup="row">/position/altitude-ft</independentVar>
							<independentVar lookup="column">fadec/limit/to-ref-temp</independentVar>
							<tableData>
								      -60   -30     0      30     60
								    0  90.3   95.9  101.0  106.0  100.8
								10000  96.4  100.2  105.6  107.1  102.6
								43000  96.4   96.7  102.1  107.4  105.1
							</tableData>
						</table>
						<table>
							<independentVar lookup="row">fadec/limit/packs-off</independentVar>
							<tableData>
								0 -0.4
								1  0.0
							</tableData>
						</table>
					</sum>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/takeoff-ref">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/limit/takeoff-input</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/takeoff">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/takeoff-ref</property>
								<value>1000</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>1000</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/mct-input">
			<function>
				<pow>
					<table>
						<independentVar lookup="row">/position/altitude-ft</independentVar>
						<independentVar lookup="column">propulsion/tat-c</independentVar>
						<tableData>
							      -60    -30     0     30     60
							    0   87.6   87.6  92.6   97.3   99.4
							10000   94.6   94.6  99.6  102.6   99.5
							43000  100.6  101.5  99.4  103.6  104.7
						</tableData>
					</table>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/mct-ref">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/limit/mct-input</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/mct">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/mct-ref</property>
								<value>1000</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>1000</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/climb-input">
			<function>
				<pow>
					<table>
						<independentVar lookup="row">/position/altitude-ft</independentVar>
						<independentVar lookup="column">propulsion/tat-c</independentVar>
						<tableData>
							      -60   -30    0     30    60
							    0  85.6  85.6  90.6  95.2  93.3
							10000  93.1  93.1  98.0  99.3  93.3
							43000  97.5  98.0  97.5  98.0  93.3
						</tableData>
					</table>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/climb-ref">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/limit/climb-input</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/climb">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/climb-ref</property>
								<value>1000</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>1000</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/cruise-input">
			<function>
				<pow>
					<table>
						<independentVar lookup="row">/position/altitude-ft</independentVar>
						<independentVar lookup="column">propulsion/tat-c</independentVar>
						<tableData>
							      -60   -30    0     30    60
							    0  81.8  81.8  86.6  91.0  89.2
							10000  89.0  89.0  93.7  94.9  89.2
							43000  93.2  93.9  93.1  93.7  89.2
						</tableData>
					</table>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/cruise-ref">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/limit/cruise-input</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/cruise">
			<function>
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/cruise-ref</property>
								<value>1000</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>1000</value>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle-input">
			<function>
				<ifthen>
					<eq>
						<property>position/wow</property>
						<value>0</value>
					</eq>
					<pow>
						<table>
							<independentVar lookup="row">velocities/mach</independentVar>
							<independentVar lookup="column">/controls/flight/flaps-input</independentVar>
							<independentVar lookup="table">/position/altitude-ft</independentVar>
							<tableData breakPoint="0">
								      0     1
								0.21  29.9  38.3
								0.70  43.8  47.5
							</tableData>
							<tableData breakPoint="43000">
								      0     1
								0.55  50.3  56.8
								0.90  59.9  62.7
							</tableData>
						</table>
						<value>3.5</value>
					</pow>
					<value>0</value>
				</ifthen>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle-ref">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/limit/idle-input</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle">
			<function> <!-- Round more finely then the thrust limit since EPR at low thrust is more fine -->
				<quotient>
					<integer>
						<sum>
							<product>
								<property>fadec/limit/idle-ref</property>
								<value>1000</value>
							</product>
							<value>0.5</value> <!-- Make it round correctly -->
						</sum>
					</integer>
					<value>1000</value>
				</quotient>
			</function>
		</fcs_function>
	
	</channel>
	
	<channel name="Reversers">
		
		<!-- Engine 1 -->
		<switch name="fadec/reverse-1/position-cmd">
			<default value="0"/>
			<test value="1">
				/controls/engines/engine[0]/reverse-lever ge 0.25
			</test>
			<test logic="AND" value="1"> <!-- Don't stow until thrust is reduced enough -->
				/engines/engine[0]/n1-actual ge 30
				fadec/reverse-1/position-cmd eq 1
			</test>
			<output>/controls/engines/engine[0]/reverse-cmd</output>
		</switch>
		
		<switch name="fadec/reverse-1/position-rate">
			<default value="0"/>
			<test logic="OR" value="1">
				/systems/hydraulics/sys-1-psi ge 1500
				/systems/acconfig/autoconfig-running eq 1
			</test>
		</switch>
		
		<actuator name="fadec/reverse-1/position-norm">
			<input>fadec/reverse-1/position-cmd</input>
			<rate_limit>fadec/reverse-1/position-rate</rate_limit>
			<output>/engines/engine[0]/reverser-pos-norm</output>
		</actuator>
		
		<pure_gain name="propulsion/engine[0]/reverser-angle-rad">
			<input>fadec/reverse-1/position-norm</input>
			<gain>3.14</gain>
		</pure_gain>
		
		<switch name="fadec/reverse-1/interlock"> <!-- Locked until 60% open, unlocked until 20% closed -->
			<default value="fadec/reverse-1/interlock"/>
			<test value="0">
				/engines/engine[0]/reverser-pos-norm ge 0.6
			</test>
			<test value="1">
				/engines/engine[0]/reverser-pos-norm le 0.2
			</test>
		</switch>
		
		<switch name="fadec/reverse-1/throttle-rev-cmd"> <!-- Seperate from the below switch on purpose -->
			<default value="0"/>
			<test value="0.84">
				/controls/engines/engine[0]/reverse-lever eq 1
			</test>
			<test value="0.56">
				/controls/engines/engine[0]/reverse-lever eq 0.75
			</test>
			<test value="0.28">
				/controls/engines/engine[0]/reverse-lever eq 0.5
			</test>
		</switch>
		
		<switch name="fadec/reverse-1/throttle-rev">
			<default value="0"/>
			<test logic="OR" value="0">
				fadec/reverse-1/interlock eq 1
				/engines/engine[0]/reverser-pos-norm lt 1
			</test>
			<test value="fadec/reverse-1/throttle-rev-cmd">
				/controls/engines/engine[0]/reverse-lever ge 0.5
			</test>
		</switch>
		
		<!-- Engine 2 -->
		<switch name="fadec/reverse-2/position-cmd">
			<default value="0"/>
			<test value="0">
				/gear/gear[0]/wow ne 1
			</test>
			<test value="1">
				/controls/engines/engine[1]/reverse-lever ge 0.25
			</test>
			<test logic="AND" value="1"> <!-- Don't stow until thrust is reduced enough -->
				/engines/engine[1]/n1-actual ge 30
				fadec/reverse-2/position-cmd eq 1
			</test>
			<output>/controls/engines/engine[1]/reverse-cmd</output>
		</switch>
		
		<switch name="fadec/reverse-2/position-rate">
			<default value="0"/>
			<test logic="OR" value="1">
				/systems/hydraulics/sys-2-psi ge 1500
				/systems/acconfig/autoconfig-running eq 1
			</test>
		</switch>
		
		<actuator name="fadec/reverse-2/position-norm">
			<input>fadec/reverse-2/position-cmd</input>
			<rate_limit>fadec/reverse-2/position-rate</rate_limit>
			<output>/engines/engine[1]/reverser-pos-norm</output>
		</actuator>
		
		<pure_gain name="propulsion/engine[1]/reverser-angle-rad">
			<input>fadec/reverse-2/position-norm</input>
			<gain>3.14</gain>
		</pure_gain>
		
		<switch name="fadec/reverse-2/interlock"> <!-- Locked until 60% open, unlocked until 20% closed -->
			<default value="fadec/reverse-2/interlock"/>
			<test value="0">
				/engines/engine[1]/reverser-pos-norm ge 0.6
			</test>
			<test value="1">
				/engines/engine[1]/reverser-pos-norm le 0.2
			</test>
		</switch>
		
		<switch name="fadec/reverse-2/throttle-rev-cmd"> <!-- Seperate from the below switch on purpose -->
			<default value="0"/>
			<test value="0.84">
				/controls/engines/engine[1]/reverse-lever eq 1
			</test>
			<test value="0.56">
				/controls/engines/engine[1]/reverse-lever eq 0.75
			</test>
			<test value="0.28">
				/controls/engines/engine[1]/reverse-lever eq 0.5
			</test>
		</switch>
		
		<switch name="fadec/reverse-2/throttle-rev">
			<default value="0"/>
			<test logic="OR" value="0">
				fadec/reverse-2/interlock eq 1
				/engines/engine[1]/reverser-pos-norm lt 1
			</test>
			<test value="fadec/reverse-2/throttle-rev-cmd">
				/controls/engines/engine[1]/reverse-lever ge 0.5
			</test>
		</switch>
		
		<!-- Engine 3 -->
		<switch name="fadec/reverse-3/position-cmd">
			<default value="0"/>
			<test value="1">
				/controls/engines/engine[2]/reverse-lever ge 0.25
			</test>
			<test logic="AND" value="1"> <!-- Don't stow until thrust is reduced enough -->
				/engines/engine[2]/n1-actual ge 30
				fadec/reverse-3/position-cmd eq 1
			</test>
			<output>/controls/engines/engine[2]/reverse-cmd</output>
		</switch>
		
		<switch name="fadec/reverse-3/position-rate">
			<default value="0"/>
			<test logic="OR" value="1">
				/systems/hydraulics/sys-3-psi ge 1500
				/systems/acconfig/autoconfig-running eq 1
			</test>
		</switch>
		
		<actuator name="fadec/reverse-3/position-norm">
			<input>fadec/reverse-3/position-cmd</input>
			<rate_limit>fadec/reverse-3/position-rate</rate_limit>
			<output>/engines/engine[2]/reverser-pos-norm</output>
		</actuator>
		
		<pure_gain name="propulsion/engine[2]/reverser-angle-rad">
			<input>fadec/reverse-3/position-norm</input>
			<gain>3.14</gain>
		</pure_gain>
		
		<switch name="fadec/reverse-3/interlock"> <!-- Locked until 60% open, unlocked until 20% closed -->
			<default value="fadec/reverse-3/interlock"/>
			<test value="0">
				/engines/engine[2]/reverser-pos-norm ge 0.6
			</test>
			<test value="1">
				/engines/engine[2]/reverser-pos-norm le 0.2
			</test>
		</switch>
		
		<switch name="fadec/reverse-3/throttle-rev-cmd"> <!-- Seperate from the below switch on purpose -->
			<default value="0"/>
			<test value="0.84">
				/controls/engines/engine[2]/reverse-lever eq 1
			</test>
			<test value="0.56">
				/controls/engines/engine[2]/reverse-lever eq 0.75
			</test>
			<test value="0.28">
				/controls/engines/engine[2]/reverse-lever eq 0.5
			</test>
		</switch>
		
		<switch name="fadec/reverse-3/throttle-rev">
			<default value="0"/>
			<test logic="OR" value="0">
				fadec/reverse-3/interlock eq 1
				/engines/engine[2]/reverser-pos-norm lt 1
			</test>
			<test value="fadec/reverse-3/throttle-rev-cmd">
				/controls/engines/engine[2]/reverse-lever ge 0.5
			</test>
		</switch>
	
	</channel>
	
	<channel name="Engine Control">
		
		<fcs_function name="fadec/limit/active-norm-ref"> <!-- Opposite of EPR Calc -->
			<function>
				<quotient>
					<difference>
						<property>fadec/limit/active</property>
						<property>fadec/epr/c2</property>
					</difference>
					<max> <!-- Prevent divide by 0 -->
						<property>fadec/epr/c1</property>
						<value>0.001</value>
					</max>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/active-norm-input"> <!-- Opposite of EPR Calc -->
			<function>
				<pow>
					<table>
						<independentVar lookup="row">fadec/limit/active-norm-ref</independentVar>
						<tableData>
							0.00     24743.1
							0.03     65768.7
							1.00  14591440.5
						</tableData>
					</table>
					<quotient>
						<value>1</value>
						<value>3.5</value>
					</quotient>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/active-norm">
			<function>
				<table>
					<independentVar lookup="row">fadec/limit/active-norm-input</independentVar>
					<tableData>
						 23.8  0
						111.4  1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<switch name="fadec/limit/ats-pitch-max">
			<default value="fadec/limit/active-norm"/>
			<test value="1"> 
				fadec/limit/active-mode-int eq 0
			</test>
		</switch>
		
		<fcs_function name="fadec/limit/idle-norm-ref"> <!-- Opposite of EPR Calc -->
			<function>
				<quotient>
					<difference>
						<property>fadec/limit/idle</property>
						<property>fadec/epr/c2</property>
					</difference>
					<max> <!-- Prevent divide by 0 -->
						<property>fadec/epr/c1</property>
						<value>0.001</value>
					</max>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle-norm-input"> <!-- Opposite of EPR Calc -->
			<function>
				<pow>
					<table>
						<independentVar lookup="row">fadec/limit/idle-norm-ref</independentVar>
						<tableData>
							0.00     24743.1
							0.03     65768.7
							1.00  14591440.5
						</tableData>
					</table>
					<quotient>
						<value>1</value>
						<value>3.5</value>
					</quotient>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/limit/idle-norm">
			<function>
				<table>
					<independentVar lookup="row">fadec/limit/idle-norm-input</independentVar>
					<tableData>
						 23.8  0
						111.4  1
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<!-- Engine 1 -->
		<switch name="fadec/control-1/max">
			<default value="fadec/limit/active-norm"/>
			<test value="1">
				/controls/fadec/eng-1-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-1/min">
			<default value="fadec/limit/idle-norm"/>
			<test value="0">
				/controls/fadec/eng-1-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-1/throttle-pos">
			<default value="/controls/engines/engine[0]/throttle"/>
			<test value="0">
				fadec/reverse-1/position-norm ne 0
			</test>
			<test logic="AND" value="fadec/ats-cmd-1">
				/it-autoflight/output/athr eq 1
				/it-autoflight/output/clamp eq 0
			</test>
		</switch>
		
		<switch name="fadec/control-1/throttle-cmd">
			<default value="fadec/control-1/throttle-pos"/>
			<test value="fadec/reverse-1/throttle-rev-cmd">
				/controls/engines/engine[0]/reverse-lever gt 0
			</test>
			<clipto>
				<min>0</min> <!-- Intentional -->
				<max>fadec/control-1/max</max>
			</clipto>
		</switch>
		
		<lag_filter name="fadec/control-1/throttle-lag">
			<input>fadec/control-1/throttle-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fadec/control-1/throttle-ref">
			<function>
				<pow>
					<table>
						<independentVar lookup="row">fadec/control-1/throttle-lag</independentVar>
						<tableData>
							0   23.8
							1  111.4
						</tableData>
					</table>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/control-1/throttle">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/control-1/throttle-ref</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<pure_gain name="fadec/control-1/throttle-pos-clamped">
			<input>fadec/control-1/throttle-pos</input>
			<gain>1.0</gain>
			<clipto>
				<min>fadec/control-1/min</min>
				<max>fadec/control-1/max</max>
			</clipto>
		</pure_gain>
		
		<switch name="fadec/control-1/throttle-output">
			<default value="fadec/control-1/throttle-pos-clamped"/>
			<test value="fadec/reverse-1/throttle-rev">
				fadec/reverse-1/position-norm ne 0
			</test>
		</switch>
		
		<lag_filter name="fadec/control-1/throttle-fdm">
			<input>fadec/control-1/throttle-output</input>
			<c1>0.75</c1>
			<output>fcs/throttle-pos-norm[0]</output>
		</lag_filter>
		
		<!-- Engine 2 -->
		<switch name="fadec/control-2/max">
			<default value="fadec/limit/active-norm"/>
			<test value="1">
				/controls/fadec/eng-2-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-2/min">
			<default value="fadec/limit/idle-norm"/>
			<test value="0">
				/controls/fadec/eng-2-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-2/throttle-pos">
			<default value="/controls/engines/engine[1]/throttle"/>
			<test value="0">
				fadec/reverse-2/position-norm ne 0
			</test>
			<test logic="AND" value="fadec/ats-cmd-2">
				/it-autoflight/output/athr eq 1
				/it-autoflight/output/clamp eq 0
			</test>
		</switch>
		
		<switch name="fadec/control-2/throttle-cmd">
			<default value="fadec/control-2/throttle-pos"/>
			<test value="fadec/reverse-2/throttle-rev-cmd">
				/controls/engines/engine[1]/reverse-lever gt 0
			</test>
			<clipto>
				<min>0</min> <!-- Intentional -->
				<max>fadec/control-2/max</max>
			</clipto>
		</switch>
		
		<lag_filter name="fadec/control-2/throttle-lag">
			<input>fadec/control-2/throttle-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fadec/control-2/throttle-ref">
			<function>
				<pow>
					<table>
						<independentVar lookup="row">fadec/control-2/throttle-lag</independentVar>
						<tableData>
							0   23.8
							1  111.4
						</tableData>
					</table>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/control-2/throttle">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/control-2/throttle-ref</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<pure_gain name="fadec/control-2/throttle-pos-clamped">
			<input>fadec/control-2/throttle-pos</input>
			<gain>1.0</gain>
			<clipto>
				<min>fadec/control-2/min</min>
				<max>fadec/control-2/max</max>
			</clipto>
		</pure_gain>
		
		<switch name="fadec/control-2/throttle-output">
			<default value="fadec/control-2/throttle-pos-clamped"/>
			<test value="fadec/reverse-2/throttle-rev">
				fadec/reverse-2/position-norm ne 0
			</test>
		</switch>
		
		<lag_filter name="fadec/control-2/throttle-fdm">
			<input>fadec/control-2/throttle-output</input>
			<c1>0.75</c1>
			<output>fcs/throttle-pos-norm[1]</output>
		</lag_filter>
		
		<!-- Engine 3 -->
		<switch name="fadec/control-3/max">
			<default value="fadec/limit/active-norm"/>
			<test value="1">
				/controls/fadec/eng-3-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-3/min">
			<default value="fadec/limit/idle-norm"/>
			<test value="0">
				/controls/fadec/eng-3-altn eq 1
			</test>
		</switch>
		
		<switch name="fadec/control-3/throttle-pos">
			<default value="/controls/engines/engine[2]/throttle"/>
			<test value="0">
				fadec/reverse-3/position-norm ne 0
			</test>
			<test logic="AND" value="fadec/ats-cmd-3">
				/it-autoflight/output/athr eq 1
				/it-autoflight/output/clamp eq 0
			</test>
		</switch>
		
		<switch name="fadec/control-3/throttle-cmd">
			<default value="fadec/control-3/throttle-pos"/>
			<test value="fadec/reverse-3/throttle-rev-cmd">
				/controls/engines/engine[2]/reverse-lever gt 0
			</test>
			<clipto>
				<min>0</min> <!-- Intentional -->
				<max>fadec/control-3/max</max>
			</clipto>
		</switch>
		
		<lag_filter name="fadec/control-3/throttle-lag">
			<input>fadec/control-3/throttle-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="fadec/control-3/throttle-ref">
			<function>
				<pow>
					<table>
						<independentVar lookup="row">fadec/control-3/throttle-lag</independentVar>
						<tableData>
							0   23.8
							1  111.4
						</tableData>
					</table>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/control-3/throttle">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/control-3/throttle-ref</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
		</fcs_function>
		
		<pure_gain name="fadec/control-3/throttle-pos-clamped">
			<input>fadec/control-3/throttle-pos</input>
			<gain>1.0</gain>
			<clipto>
				<min>fadec/control-3/min</min>
				<max>fadec/control-3/max</max>
			</clipto>
		</pure_gain>
		
		<switch name="fadec/control-3/throttle-output">
			<default value="fadec/control-3/throttle-pos-clamped"/>
			<test value="fadec/reverse-3/throttle-rev">
				fadec/reverse-3/position-norm ne 0
			</test>
		</switch>
		
		<lag_filter name="fadec/control-3/throttle-fdm">
			<input>fadec/control-3/throttle-output</input>
			<c1>0.75</c1>
			<output>fcs/throttle-pos-norm[2]</output>
		</lag_filter>
	
	</channel>
	
	<channel name="Engine Parameters" execrate="2">
		
		<lag_filter name="fadec/n1-actual-1">
			<input>/engines/engine[0]/n1</input>
			<c1>2.25</c1>
			<output>/engines/engine[0]/n1-actual</output>
			<output>/engines/engine[4]/n1</output>
		</lag_filter>
		
		<lag_filter name="fadec/n1-actual-2">
			<input>/engines/engine[1]/n1</input>
			<c1>2.25</c1>
			<output>/engines/engine[1]/n1-actual</output>
			<output>/engines/engine[5]/n1</output>
		</lag_filter>
		
		<lag_filter name="fadec/n1-actual-3">
			<input>/engines/engine[2]/n1</input>
			<c1>2.25</c1>
			<output>/engines/engine[2]/n1-actual</output>
			<output>/engines/engine[6]/n1</output>
		</lag_filter>
		
		<fcs_function name="fadec/epr-actual-1-ref">
			<function>
				<pow>
					<property>fadec/n1-actual-1</property>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/epr-actual-1">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/epr-actual-1-ref</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
			<output>/engines/engine[0]/epr-actual</output>
		</fcs_function>
		
		<fcs_function name="fadec/epr-actual-2-ref">
			<function>
				<pow>
					<property>fadec/n1-actual-2</property>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/epr-actual-2">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/epr-actual-2-ref</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
			<output>/engines/engine[1]/epr-actual</output>
		</fcs_function>
		
		<fcs_function name="fadec/epr-actual-3-ref">
			<function>
				<pow>
					<property>fadec/n1-actual-3</property>
					<value>3.5</value>
				</pow>
			</function>
		</fcs_function>
		
		<fcs_function name="fadec/epr-actual-3">
			<function>
				<sum>
					<product>
						<table>
							<independentVar lookup="row">fadec/epr-actual-3-ref</independentVar>
							<tableData>
								   24743.1  0.00
								   65768.7  0.03
								14591440.5  1.00
							</tableData>
						</table>
						<property>fadec/epr/c1</property>
					</product>
					<property>fadec/epr/c2</property>
				</sum>
			</function>
			<output>/engines/engine[2]/epr-actual</output>
		</fcs_function>
		
		<lag_filter name="fadec/n2-actual-1">
			<input>/engines/engine[0]/n2</input>
			<c1>2.25</c1>
			<output>/engines/engine[0]/n2-actual</output>
			<output>/engines/engine[4]/n2</output>
		</lag_filter>
		
		<lag_filter name="fadec/n2-actual-2">
			<input>/engines/engine[1]/n2</input>
			<c1>2.25</c1>
			<output>/engines/engine[1]/n2-actual</output>
			<output>/engines/engine[5]/n2</output>
		</lag_filter>
		
		<lag_filter name="fadec/n2-actual-3">
			<input>/engines/engine[2]/n2</input>
			<c1>2.25</c1>
			<output>/engines/engine[2]/n2-actual</output>
			<output>/engines/engine[6]/n2</output>
		</lag_filter>
	
	</channel>
	
	<channel name="EAD" execrate="8">
		
		<switch name="fadec/eng-1-powered">
			<default value="0"/>
			<test value="1">
				/engines/engine[0]/state eq 3
			</test>
			<test logic="AND" value="1">
				/systems/electrical/outputs/efis ge 25
				/engines/engine[0]/n2-actual ge 1
			</test>
		</switch>
		
		<switch name="fadec/eng-2-powered">
			<default value="0"/>
			<test value="1">
				/engines/engine[1]/state eq 3
			</test>
			<test logic="AND" value="1">
				/systems/electrical/outputs/efis ge 25
				/engines/engine[1]/n2-actual ge 1
			</test>
		</switch>
		
		<switch name="fadec/eng-3-powered">
			<default value="0"/>
			<test value="1">
				/engines/engine[2]/state eq 3
			</test>
			<test logic="AND" value="1">
				/systems/electrical/outputs/efis ge 25
				/engines/engine[2]/n2-actual ge 1
			</test>
		</switch>
		
		<switch name="fadec/eng-1-rev-state">
			<default value="0"/>
			<test value="2"> <!-- REV -->
				fadec/reverse-1/position-norm eq 1
			</test>
			<test logic="OR" value="1"> <!-- U/L -->
				/controls/engines/engine[0]/reverse-lever gt 0
				fadec/reverse-1/position-norm gt 0
			</test>
		</switch>
		
		<switch name="fadec/eng-2-rev-state">
			<default value="0"/>
			<test value="2"> <!-- REV -->
				fadec/reverse-2/position-norm eq 1
			</test>
			<test logic="OR" value="1"> <!-- U/L -->
				/controls/engines/engine[1]/reverse-lever gt 0
				fadec/reverse-2/position-norm gt 0
			</test>
		</switch>
		
		<switch name="fadec/eng-3-rev-state">
			<default value="0"/>
			<test value="2"> <!-- REV -->
				fadec/reverse-3/position-norm eq 1
			</test>
			<test logic="OR" value="1"> <!-- U/L -->
				/controls/engines/engine[2]/reverse-lever gt 0
				fadec/reverse-3/position-norm gt 0
			</test>
		</switch>
	
	</channel>
	
	<channel name="EAD" execrate="2">
		
		<fcs_function name="/DU/EAD/EPR[0]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[0]/epr-actual</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EPR[1]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[1]/epr-actual</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EPR[2]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[2]/epr-actual</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EPRthr[0]">
			<function>
				<table>
					<independentVar lookup="row">fadec/control-1/throttle</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EPRthr[1]">
			<function>
				<table>
					<independentVar lookup="row">fadec/control-2/throttle</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EPRthr[2]">
			<function>
				<table>
					<independentVar lookup="row">fadec/control-3/throttle</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EPRLimit">
			<function>
				<table>
					<independentVar lookup="row">fadec/limit/active</independentVar>
					<tableData>
						0 -134
						1  -53
						2   28
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/N1[0]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[0]/n1-actual</independentVar>
					<tableData>
						  0.0 -134
						117.5   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/N1[1]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[1]/n1-actual</independentVar>
					<tableData>
						  0.0 -134
						117.5   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/N1[2]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[2]/n1-actual</independentVar>
					<tableData>
						  0.0 -134
						117.5   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<!--fcs_function name="/DU/EAD/EGT[0]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[0]/egt-actual</independentVar>
					<tableData>
						  0 -134
						600   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EGT[1]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[1]/egt-actual</independentVar>
					<tableData>
						  0 -134
						600   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/EGT[2]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[2]/egt-actual</independentVar>
					<tableData>
						  0 -134
						600   40
					</tableData>
				</table>
			</function>
		</fcs_function-->
		
		<fcs_function name="/DU/EAD/N2[0]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[0]/n2-actual</independentVar>
					<tableData>
						  0.0 -134
						117.5   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/N2[1]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[1]/n2-actual</independentVar>
					<tableData>
						  0.0 -134
						117.5   40
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="/DU/EAD/N2[2]">
			<function>
				<table>
					<independentVar lookup="row">/engines/engine[2]/n2-actual</independentVar>
					<tableData>
						  0.0 -134
						117.5   40
					</tableData>
				</table>
			</function>
		</fcs_function>
	
	</channel>

</system>
